"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useSearchState = void 0;
const react_1 = require("react");
const SearchHeadlessContext_1 = require("./SearchHeadlessContext");
const with_selector_1 = require("use-sync-external-store/shim/with-selector");
/**
 * Returns the Search State returned by the map function.
 * Uses "use-sync-external-store/shim" to handle reading
 * and subscribing from external store in React version
 * pre-18 and 18.
 */
function useSearchState(stateSelector) {
    const search = (0, react_1.useContext)(SearchHeadlessContext_1.SearchHeadlessContext);
    if (search.state === undefined) {
        throw new Error('Attempted to call useSearchState() outside of SearchHeadlessProvider.'
            + ' Please ensure that \'useSearchState()\' is called within an SearchHeadlessProvider component.');
    }
    const getSnapshot = (0, react_1.useCallback)(() => search.state, [search.state]);
    const isMountedRef = (0, react_1.useRef)(false);
    (0, react_1.useEffect)(() => {
        isMountedRef.current = true;
        return () => {
            isMountedRef.current = false;
        };
    }, []);
    const subscribe = (0, react_1.useCallback)(cb => search.addListener({
        valueAccessor: state => state,
        callback: () => {
            // prevent React state update on an unmounted component
            if (!isMountedRef.current) {
                return;
            }
            cb();
        }
    }), [search]);
    const selectedState = (0, with_selector_1.useSyncExternalStoreWithSelector)(subscribe, getSnapshot, getSnapshot, stateSelector);
    return selectedState;
}
exports.useSearchState = useSearchState;
//# sourceMappingURL=useSearchState.js.map