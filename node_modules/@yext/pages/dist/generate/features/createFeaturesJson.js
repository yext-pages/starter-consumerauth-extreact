import fs from "fs-extra";
import path from "path";
import {
  convertTemplateConfigToFeatureConfig
} from "../../common/src/feature/features.js";
const getFeaturesConfig = async (templateModules) => {
  const features = [];
  const streams = [];
  for (const [, module] of templateModules.entries()) {
    const featureConfig = convertTemplateConfigToFeatureConfig(module.config);
    features.push(featureConfig);
    module.config.stream && streams.push({ ...module.config.stream });
  }
  return { features, streams };
};
const createFeaturesJson = async (templateModules, featurePath) => {
  const { features, streams } = await getFeaturesConfig(templateModules);
  const featureDir = path.dirname(featurePath);
  if (!fs.existsSync(featureDir)) {
    fs.mkdirSync(featureDir);
  }
  const featuresJson = mergeFeatureJson(featurePath, features, streams);
  fs.writeFileSync(featurePath, JSON.stringify(featuresJson, null, "  "));
};
const mergeFeatureJson = (featurePath, features, streams) => {
  let originalFeaturesJson = {};
  if (fs.existsSync(featurePath)) {
    originalFeaturesJson = JSON.parse(fs.readFileSync(featurePath).toString());
  }
  return {
    ...originalFeaturesJson,
    features,
    streams
  };
};
export {
  createFeaturesJson,
  getFeaturesConfig
};
